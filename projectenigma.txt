import speech_recognition as speechrecog  # importing python speech recognition library
import pyttsx3 as tsx  # importing python text to speak library to add Enigma cap to speak
import pywhatkit  # importing whatkit to play some entertainment
import datetime
import wikipedia

# Setting up enigma cap for recognizing speech
recog = speechrecog.Recognizer()

# Setting up enigma cap for speaking
engineEnigma = tsx.init()
voices = engineEnigma.getProperty('voices')
engineEnigma.setProperty('voice', voices[0].id)

volume = engineEnigma.getProperty('volume')
engineEnigma.setProperty('volume', 1.0)

rate = engineEnigma.getProperty('rate')
engineEnigma.setProperty('rate', 145)


def enigmagreetings():
    engineEnigma.say('Enigma is here Sir')
    engineEnigma.say('What can i do for you')
    engineEnigma.runAndWait()


def enigmatalk(text):
    engineEnigma.say(text)
    engineEnigma.runAndWait()


def input_enigma():
    try:
        with speechrecog.Microphone() as source:
            print('...')
            voicein = recog.listen(source)
            ident = recog.recognize_google(voicein)
            ident = ident.lower()
            if 'enigma' in ident:
                ident = ident.replace('enigma', '')
    except:
        pass
    return ident


def run_enigma():
    ident = input_enigma()
    if 'play' in ident:
        print('You said ', ident)
        playsong1 = ident.replace('play', '')
        enigmatalk('Playing your request')
        pywhatkit.playonyt(playsong1)


    elif 'playing' in ident:
        print('You said ', ident)
        playsong2 = ident.replace('playing', '')
        enigmatalk('PLaying your request')
        pywhatkit.playonyt(playsong2)

    elif 'time' in ident:
        showtime = datetime.datetime.now().strftime('%I:%M %p')
        speaktime = datetime.datetime.now().strftime('%I %M %p')
        print('Today is ', showtime)
        enigmatalk('Today is'+ speaktime)

    elif 'location' in ident:
        import requests
        res = requests.get('https://ipinfo.io/')
        data = res.json()

        city = data['city']
        region = data['region']
        timezone = data['timezone']
        timezone1 = timezone.replace('/',' ')
        print('You are now in '+ city+', '+region+', '+' '+timezone1)
        enigmatalk('You are now in City of'+city+'region of'+region+'And timezone of'+timezone1)

    elif 'weather' in ident:
        import requests
        res = requests.get('https://ipinfo.io/')
        data = res.json()
        city = data['city']

        todayforecast = 'https://api.openweathermap.org/data/2.5/weather?q={}&appid=6dd34d9a0373541ca1527f5354633afe&units=metric'.format(city)
        res2 = requests.get(todayforecast)
        data2 = res2.json()

        rovercast = str(data2['weather'][0]['description'])
        rtemp = str(data2['main']['feels_like'])
        rhumidity = str(data2['main']['humidity'])
        rvisibility = str(data2['visibility'])
        todaynow = datetime.datetime.now().strftime('%A, %B %d %Y')

        print(todaynow)
        print('')
        print('Weather Status: '+rovercast)
        print('Temperature: '+rtemp+u"\u00b0"+'c')
        print('Humidity: '+rhumidity+'%')
        print('Visibility Rate: '+rvisibility)

        enigmatalk('Today is'+todaynow)
        enigmatalk('You will have'+rovercast)
        enigmatalk('With temperature of'+rtemp+u"\u00b0"+'Celsius')
        enigmatalk('Then humidity of'+rhumidity+'%')
        enigmatalk('Visibility rate is'+rvisibility)
        if 'rain' in rovercast:
            enigmatalk('Since its a rainy days, i suggest you to bring the umbrella Sir')

    elif 'who' in ident:
        whoinfo = ident.replace('who', '')
        searchwho = wikipedia.summary(ident, 3)
        print(searchwho)
        enigmatalk(searchwho)

    elif 'what is' in ident:
        whatinfo = ident.replace('what is','')
        print(whatinfo)
        searchwhat = wikipedia.summary(whatinfo, 3)
        print(searchwhat)
        enigmatalk(searchwhat)

    elif 'define' in ident:
        defineinfo = ident.replace('define','')
        print(defineinfo)
        searchdefine = wikipedia.summary(defineinfo, 5)
        print(searchdefine)
        enigmatalk(searchdefine)

    elif 'explain about' in ident:
        explaininfo = ident.replace('explain about','')
        print(explaininfo)
        searchexplain = wikipedia.summary(explaininfo, 5)
        print(searchexplain)
        enigmatalk(searchexplain)

    elif 'where is' in ident:
        whereinfo = ident.replace('where is', '')
        print(whereinfo)
        searchwhere = wikipedia.summary(whereinfo, 5)
        print(searchwhere)
        enigmatalk(searchwhere)

    else:
        print('Request cant be specified Sir. Please try again')
        enigmatalk('Request cant be specified Sir. Please try again')


enigmagreetings()
run_enigma()